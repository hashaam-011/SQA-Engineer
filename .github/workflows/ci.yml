name: TaskMaster Pro - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # API Testing Job
  api-tests:
    name: ðŸ§ª API Tests (Jest + Supertest)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    defaults:
      run:
        working-directory: ./server

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ§ª Run API Tests
      run: npm test

    - name: ðŸ“Š Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./server/coverage/lcov.info
        flags: api-tests
        name: API Coverage
        fail_ci_if_error: false

  # UI Testing Job
  ui-tests:
    name: ðŸŽ­ UI Tests (Cypress E2E)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          client/package-lock.json

    - name: ðŸ“¦ Install Server Dependencies
      working-directory: ./server
      run: npm ci

    - name: ðŸ“¦ Install Client Dependencies
      working-directory: ./client
      run: npm ci

    - name: ðŸš€ Start Backend Server
      working-directory: ./server
      run: npm start &

    - name: â³ Wait for Backend
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:5000; do sleep 1; done'

    - name: ðŸš€ Start Frontend Server
      working-directory: ./client
      run: npm start &

    - name: â³ Wait for Frontend
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 1; done'

    - name: ðŸŽ­ Run Cypress Tests
      working-directory: ./client
      run: npx cypress run --spec cypress/e2e/ui-tests.spec.js

    - name: ðŸ“¸ Upload Screenshots
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: cypress-screenshots-${{ matrix.node-version }}
        path: client/cypress/screenshots

    - name: ðŸŽ¥ Upload Videos
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: cypress-videos-${{ matrix.node-version }}
        path: client/cypress/videos

  # Code Quality & Security
  code-quality:
    name: ðŸ” Code Quality & Security
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          client/package-lock.json

    - name: ðŸ“¦ Install Dependencies
      run: |
        cd server && npm ci
        cd client && npm ci

    - name: ðŸ” Run ESLint (Server)
      working-directory: ./server
      run: npx eslint . --ext .js || true

    - name: ðŸ” Run ESLint (Client)
      working-directory: ./client
      run: npx eslint src --ext .js,.jsx || true

    - name: ðŸ›¡ï¸ Run Security Audit
      run: |
        cd server && npm audit --audit-level=high || true
        cd client && npm audit --audit-level=high || true

  # Deployment Readiness Check
  deployment-check:
    name: ðŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests, code-quality]

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          client/package-lock.json

    - name: ðŸ“¦ Install Dependencies
      run: |
        cd server && npm ci
        cd client && npm ci

    - name: ðŸ—ï¸ Build Client
      working-directory: ./client
      run: npm run build

    - name: âœ… Deployment Ready
      run: echo "ðŸŽ‰ All tests passed! Ready for deployment."

    - name: ðŸ“ Generate Test Report
      run: |
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… API Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… UI Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code Quality: Checked" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build: Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Ready for Production Deployment!**" >> $GITHUB_STEP_SUMMARY